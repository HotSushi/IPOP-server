{{extend 'layout.html'}}
<link rel="stylesheet" type="text/css" href="/IPOP/static/css/d3graph.css">
<script src="/IPOP/static/js/d3graph.js"></script>
<script src="/IPOP/static/js/d3.min.js"></script>
<script src="/IPOP/static/js/d3.tip.v0.6.3.js"></script>
<script>
    //networkmap click callback
   function ongraphclick(d) {
          if (d3.event.defaultPrevented) return; // ignore drag
          if(d.group == 0){
              uri = "node="+d.name;
              window.location = "http://127.0.0.1:8000{{=URL('log')}}?"+encodeURI(uri);
           }
           else{
              uri = "xmppid="+d.name;
              window.location = "http://127.0.0.1:8000{{=URL('monitor')}}?"+encodeURI(uri);
           }
    }
    function delet(stringg){
       uri = "jids="+stringg;
       var r = $.get( "http://127.0.0.1:8000{{=URL('delet')}}?"+encodeURI(uri));
   }
   function stopvpn(stringg){
       uri = "type=stop&xmppid="+stringg;
       var r = $.post( "http://127.0.0.1:8000{{=URL('sendtoclient')}}?"+encodeURI(uri));
   }
   function changeip(xmppid){
       ip = prompt("please enter new IP","192.168.10.1")
       if (ip != null){
           uri = "type=change_ip&xmppid=" + xmppid + "&ip=" + ip;
           $.post( "http://127.0.0.1:8000{{=URL('set')}}?"+encodeURI(uri));
           $.post( "http://127.0.0.1:8000{{=URL('sendtoclient')}}?"+encodeURI(uri));
       }
   }

   window.setInterval(reloader, 2000);
   var json_file = null;
   function reloader() {
    $.getJSON("http://127.0.0.1:8000{{=URL('editgvpn.json')}}", function(result){
        if(json_file == null){
            json_file = JSON.stringify(result);
        }
        else{
            if(json_file !== JSON.stringify(result)){
                location.reload(true);
                //<meta http-equiv="refresh" content="10">
            }
        }
    });
    }

//networkmap fetch data
{{for i in range(1,len(json)+1):}}  
    $.getJSON("http://127.0.0.1:8000{{= URL('getgraph.json?vpnid='+ str(json[i]['vpn_id'])) }}", function(result){
        creategraph(result,"#networkmap_{{=json[i]['vpn_id']}}");
    });
{{pass}}

</script>
<h1>Edit GVPN</h1>


{{for i in range(1,len(json)+1):}}
    <div>
    <h2>{{=json[i]['vpn_name']}}</h2>
    <h5>{{=json[i]['vpn_admin'] +":"+ json[i]['vpn_password'] +":"+ str(json[i]['vpn_ipv4mask']) }}</h5>
    <div id="networkmap_{{=json[i]['vpn_id']}}"></div>
    <h5>Nodes</h5>
    {{ nodes = json[i]['nodes'] }}
    {{ for j in range(1,len(nodes)+1): }}

            {{= " : ".join(nodes[j].values()[1:]) }}
            <a style = " color:{{if nodes[j]['status'] == 'stopped':}}red {{else:}} green {{pass}}" > : {{=nodes[j]['status']}}</a>
            <button onclick="stopvpn( '{{= nodes[j]['jid'] }}' )">Stop</button> : 
            <button onclick="changeip( '{{= nodes[j]['jid'] }}' )">Change IP</button>:
            <button onclick="delet( '{{= nodes[j]['jid'] }}' )">Delete node</button>
            <br>

    {{pass}}
    </div>
{{pass}}
